<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>title</title>
    <link rel="stylesheet" href="css/style.css">
  </head>
  <body>
    <!-- page content -->
    <div>
        Location:
        <input type="text" id="pos_lat", placeholder="Latitude"></input>
        <input type="text" id="pos_lon", placeholder="Longitude"></input>
    </div>
    <div>
        EZCOD:
        <input type="text" id="ezcod_5_10", placeholder="EZCOD 5:10">
        <input type="text" id="ezcod_5_11", placeholder="EZCOD 5:11">
        <input type="text" id="ezcod_5_12", placeholder="EZCOD 5:12">
    </div>
    <div>
        <iframe id="map" width="600" height="450" frameborder="0" style="border:0"
                src="https://www.google.com/maps/embed/v1/place?q=0,0&key=AIzaSyA78qkyxebEk4-XOJWfbedywxc7Bxen1eY">
        </iframe>
    </div>
    <script src="js/jquery-1.10.2.min.js"></script>
    <script src="js/ezpwd/ezcod_5.js"></script>		<!-- emscripten compiled ezcod_5 API -->
    <script src="js/ezpwd/ezcod_5_wrap.js"></script>
    <script type="text/javascript">
        $('input#ezcod_5_10')
            .data( 'encode', ezcod_5_10_encode )
            .data( 'decode', ezcod_5_10_decode );
        $('input#ezcod_5_11')
            .data( 'encode', ezcod_5_11_encode )
            .data( 'decode', ezcod_5_11_decode );
        $('input#ezcod_5_12')
            .data( 'encode', ezcod_5_12_encode )
            .data( 'decode', ezcod_5_12_decode );
        $('input[id^="pos"]')
            .off( 'blur keyup' )
            .on(  'blur keyup', encoding );
        $('input[id^="ezcod"')
            .off( 'blur keyup' )
            .on(  'blur keyup', decoding );

        function updating( lat, lon )
        {
            console.log([ "updating w/ lat:", lat, "lon:", lon ]);
            $('input[id^="ezcod"')
                .each( function() {
                    $(this).val( $(this).data( 'encode' )( lat, lon ));
                });
            var			latnum	= parseFloat( lat );
            var			lonnum	= parseFloat( lon );
            if ( isNaN( lat ) || isNaN( lon ))
                return;
            var			latstr	= latnum.toFixed( 7 );
            var			lonstr	= lonnum.toFixed( 7 );
            $('input#pos_lat').val( latstr );
            $('input#pos_lon').val( lonstr );
            $('#map').attr( 'src',
                            'https://www.google.com/maps/embed/v1/place?q='
                            + latstr + ',' + lonstr 
                            + '&key=AIzaSyA78qkyxebEk4-XOJWfbedywxc7Bxen1eY' );
        }

        function encoding( e ) {
            // On blur/<return>, send new lat/lon values to encode
            if (e.type === 'keyup' && e.keyCode !== 10 && e.keyCode !== 13)
                return;
            var			lat	= $('input#pos_lat').val();
            var			lon	= $('input#pos_lon').val();
            if ( ! lat || ! lon )
                return; // one or both are empty/undefined
            updating( lat, lon );
        }

        function decoding( e ) {
            // On blur/<return>, send new ezcod 5:N to decode and get new lat/lon
            if (e.type === 'keyup' && e.keyCode !== 10 && e.keyCode !== 13)
                return;
            var			cod	= $(this).val();
            if ( ! cod )
                return;
            var			pos	= $(this).data( 'decode' )( cod );
            updating( pos[0], pos[1] );
        }

        // Obtain geolocation if possible
        if ( navigator.geolocation.getCurrentPosition ) {
            navigator.geolocation.getCurrentPosition( show_position );
        } else {
            console.log( "Geolocation is not supported by this browser." );
        }

        function show_position( position ) {
            console.log( "Current browser geolocation lat: "
                         + position.coords.latitude + ", " + position.coords.longitude );
            updating( position.coords.latitude, position.coords.longitude );
        }
    </script>
  </body>
</html>
